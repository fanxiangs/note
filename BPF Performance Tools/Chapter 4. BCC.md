本章介绍了 **BPF Compiler Collection (BCC)**，这个开源项目包含了一个编译器框架和库，用于构建 BPF 软件。BCC 是 BPF 的主要前端项目，得到了 BPF 开发者的支持，并且是许多最新内核跟踪功能首次使用的地方。BCC 还包含了超过 70 个可以直接运行的 BPF 性能分析和故障排查工具，许多工具将在本书中详细介绍。
**BCC 概述**
- **BCC (BPF Compiler Collection)**：BCC 是 BPF 的前端工具集，提供了一个构建 BPF 程序的框架。它包含了多个库和工具，帮助用户利用 eBPF（扩展的 BPF）进行内核级的性能分析、故障排查和监控。
- **创建与发展**：BCC 由 **Brenden Blanco** 在 2015 年 4 月创建，得到 **Alexei Starovoitov** 的支持。此后，越来越多的开发者参与其中，BCC 成为了像 Netflix 和 Facebook 这样的公司默认的服务器安装工具。
**学习目标**
1. **了解 BCC 的特性和组件**：包括其工具和文档。
2. **理解单功能工具与多功能工具的利弊**。
3. **学习如何使用 `funccount(8)` 多功能工具** 进行事件计数。
4. **学习如何使用 `stackcount(8)` 多功能工具** 来发现代码路径。
5. **学习如何使用 `trace(8)` 多功能工具** 来为每个事件进行自定义打印。
6. **学习如何使用 `argdist(8)` 多功能工具** 来进行分布总结。
7. （可选）**了解 BCC 的内部实现**。
8. **了解 BCC 调试技巧**。
## BCC COMPONENTS
## BCC FEATURES
### **BCC Features Overview**

BCC 是一个开源项目，由来自不同公司的工程师创建和维护，并非商业化产品。如果它是一个商业产品，可能会有营销部门来宣传其功能和特点。功能列表通常是了解新技术能力的有效方式。在 BPF 和 BCC 开发过程中，作者创建了所需功能的列表，这些功能现在已经实现，并分为内核级特性和用户级特性。以下是 BCC 的主要功能：
### **Kernel-Level Features**
这些是 BCC 可以使用的内核级特性，包括 BPF、kprobes、uprobes 等功能。详细的实现内容可以参考第二章的背景知识。
- **动态仪器化，内核级**：通过 BPF 支持 kprobes，能够在内核中动态插入探针，监控内核函数的执行。
- **动态仪器化，用户级**：通过 BPF 支持 uprobes，能够在用户空间程序中插入探针，监控用户程序的执行。
- **静态跟踪，内核级**：通过 BPF 支持 tracepoints，用于在内核中跟踪静态事件。
- **定时采样事件**：通过 BPF 与 `perf_event_open()` 结合使用，可以进行定时采样，收集事件数据。
- **PMC（性能监控计数器）事件**：结合 `perf_event_open()`，可以跟踪硬件性能监控计数器事件。
- **过滤功能**：通过 BPF 程序进行事件过滤，只收集感兴趣的事件。
- **调试输出**：使用 `bpf_trace_printk()` 输出调试信息，方便开发和调试。
- **每事件输出**：使用 `bpf_perf_event_output()` 进行每个事件的输出处理。
- **基本变量**：支持全局变量和每线程变量，通过 BPF maps 实现。
- **关联数组**：通过 BPF maps 支持关联数组（key-value 映射），方便数据存储。
- **频率计数**：通过 BPF maps 实现频率计数，记录事件发生的次数。
- **直方图**：支持不同类型的直方图，包括二的幂次、线性以及自定义的直方图，均通过 BPF maps 实现。
- **时间戳和时间差**：通过 `bpf_ktime_get_ns()` 获取时间戳，支持时间差计算和存储。
- **堆栈跟踪，内核级**：使用 BPF stackmap 实现内核级的堆栈跟踪。
- **堆栈跟踪，用户级**：同样通过 BPF stackmap 支持用户空间的堆栈跟踪。
- **覆盖环形缓冲区**：通过 `perf_event_attr.write_backward` 支持覆盖式的环形缓冲区。
- **低开销仪器化**：通过 BPF JIT 编译和 BPF map 汇总，减少对系统的性能影响。
- **生产环境安全**：BPF 验证器确保 BPF 程序的安全性和稳定性，防止恶意代码的执行。
### **BCC User-Level Features**
这些是 BCC 用户级前端和 BCC 仓库提供的功能：
- **静态跟踪，用户级**：通过支持 USDT（User-level Statically Defined Tracing）探针，在用户空间进行静态跟踪。
- **调试输出**：通过 Python 中的 `BPF.trace_pipe()` 和 `BPF.trace_fields()` 实现调试输出，便于分析和调试。
- **每事件输出**：使用 `BPF_PERF_OUTPUT` 宏和 `BPF.open_perf_buffer()` 函数，提供每个事件的输出。
- **间隔输出**：通过 `BPF.get_table()` 和 `table.clear()` 进行周期性输出，可以定期收集表格数据。
- **直方图打印**：使用 `table.print_log2_hist()` 打印直方图数据，适用于数据分布分析。
- **C 结构体导航，内核级**：通过 BCC 重写器映射到 `bpf_probe_read()`，支持 C 结构体的导航和访问。
- **符号解析，内核级**：使用 `ksym()` 和 `ksymaddr()` 进行内核符号解析，帮助定位函数和变量。
- **符号解析，用户级**：通过 `usymaddr()` 进行用户空间符号解析。
- **调试信息符号解析支持**：支持调试符号的解析，帮助开发者分析调试信息。
- **BPF tracepoint 支持**：通过 `TRACEPOINT_PROBE` 支持内核和用户空间的 tracepoint。
- **BPF 堆栈跟踪支持**：通过 `BPF_STACK_TRACE` 支持堆栈跟踪，可以追踪函数调用栈。
- **各种其他辅助宏和函数**：BCC 提供了许多辅助宏和函数，用于简化 BPF 程序的开发。
- **示例**：在 `/examples` 目录下提供了丰富的示例代码，帮助开发者快速上手。
- **工具**：在 `/tools` 目录下提供了许多现成的工具，适用于性能分析和故障排查。
- **教程**：在 `/docs/tutorial*.md` 文件中提供了详细的教程，帮助用户了解如何使用 BCC 进行性能分析。
- **参考手册**：提供 `/docs/reference_guide.md` 作为开发者的参考手册，详细介绍了 BCC 的各个功能和接口。
## BCC INSTALLATION