 **核心概念**
在前面的学习中，我们使用了一个简化的计算机系统模型：CPU 用于执行指令，内存系统用于存储指令和数据，且 CPU 可在固定时间内访问任意内存位置。然而，这个模型并不符合现代计算机系统的实际工作方式。

现代内存系统是一个**层次化结构**，由不同容量、成本和访问时间的存储设备组成。其主要特征是：
1. **层级结构**：
   - **顶层**：CPU 寄存器，存储最常用的数据。
   - **中间层**：高速缓存（cache），为 CPU 提供快速访问主存（main memory）中少量数据的通道。
   - **底层**：主存用于存储大规模数据，但访问速度较慢。它还可以作为存储更慢的大容量磁盘的中转站。
   - **更深层次**：磁盘或网络连接的外部存储设备（如其他计算机的磁盘或磁带）。

2. **成本与性能权衡**：
   - 越靠近 CPU，访问速度越快，但存储容量越小，成本越高。
   - 越靠近底层，容量越大，成本越低，但访问速度更慢。

3. **有效性**：
   - 内存层次的有效性依赖于程序的访问模式。**频繁访问的存储层应靠近 CPU**，以实现性能最优化。

---
#### 本章内容
1. **基础存储技术**：
   - **SRAM（静态随机存储器）**：速度快，用于实现缓存。
   - **DRAM（动态随机存储器）**：容量大但较慢，用于实现主存。
   - **ROM（只读存储器）**：非易失性存储，用于存储固件。
   - **旋转磁盘与固态硬盘**：大容量存储，但速度慢。
2. **缓存的作用与性能影响**：
   - 缓存作为 CPU 和主存之间的数据缓冲区域，是内存层次对性能影响最大的部分。
   - 学习如何分析 C 程序的局部性，以及如何优化程序的访问模式以提高缓存利用率。
3. **内存山（Memory Mountain）**：
   - 一种直观的方式，通过绘制访问延迟与局部性的关系，描述特定机器的内存层次性能。

---
#### 本章目标
- 内存层次的组织与工作原理。
- 如何分析程序的内存访问模式。
- 针对局部性优化程序的技巧。
- 使用内存山图直观理解和评估内存性能。
# 6.1 Storage Technologies（存储技术）

## **6.1.1 随机存取存储器 (Random Access Memory, RAM)**

随机存取存储器有两种主要类型：**静态随机存储器 (SRAM)** 和 **动态随机存储器 (DRAM)**，
SRAM：速度快，成本高，通常用于 CPU 芯片内外的高速缓存 (cache)。
DRAM：容量大，成本低，主要用于主存和图形系统的帧缓冲区。
通常，一个台式机系统配备数十 MB 的 SRAM 和数百至数千 MB 的 DRAM。


---

### **1静态随机存储器 (SRAM)**

- **存储原理**：每一位数据存储在一个**双稳态存储单元**中，由六个晶体管组成。双稳态意味着：
    - 单元可以稳定地存在于两个不同的电压状态（0或1）。
    - 受到干扰（如电噪声）后，系统会恢复到最近的稳定状态。
    - 类比于**倒立摆**（如图6.1），摆只有两个稳定状态（向左或向右倾斜），中间状态是不稳定的。
- **特点**：
    - **无需刷新**：只要保持供电，数据会永久保留。
    - **快速且抗干扰**：不容易受电噪声或光线干扰。
    - **高成本与低密度**：每位需要6个晶体管，因此成本高且密度低。
    - **主要用途**：用作**缓存存储器**（cache memory）。

---

### **2. 动态随机存储器 (DRAM)**

- **存储原理**：每一位数据存储为电容上的电荷，且仅需1个晶体管和1个电容。
    - 电容非常小（约30飞法，30 × 10⁻¹⁵法拉）。
    - 电容会因漏电流导致电荷丢失，因此需要**定期刷新**。
    - 刷新过程：读取数据后重新写回，以维持电荷。
- **特点**：
    - **易受干扰**：光线或电噪声可能影响存储状态。
    - **需要刷新**：大约每10到100毫秒刷新一次。
    - **高密度与低成本**：占用晶体管资源少，适合大规模存储。
    - **主要用途**：用作**主存**和**图形帧缓冲区**（frame buffer）。
- **额外优化**：一些系统使用纠错码（ECC）技术，通过增加少量冗余位来检测和纠正单个位错误（如用72位表示64位数据）。

**SRAM与DRAM的对比**（如图6.2）

| **特性**  | **SRAM** | **DRAM**  |
| ------- | -------- | --------- |
| 晶体管数/每位 | 6        | 1         |
| 相对访问时间  | 1×       | 10×       |
| 数据是否持久  | 是（只要供电）  | 否         |
| 抗干扰性    | 不敏感      | 敏感        |
| 相对成本    | 1,000×   | 1×        |
| 应用场景    | 缓存存储器    | 主存、图形帧缓冲区 |

---

### **3. 传统的 DRAM**

- **超级单元 (Supercell)**：DRAM中的最小存储单元组。
    - 包含多个DRAM单元（如8位），并组成**行×列的二维数组**。
    - 通过**行地址 (RAS)** 和 **列地址 (CAS)** 定位。
- **示例**（如图6.3、6.4）：
    - 一个16×8的DRAM有16个超级单元，每个超级单元存储8位数据。
    - 通过行地址和列地址读取指定的超级单元：
        1. 发送行地址`i`（RAS请求），将整行加载到内部行缓冲区。
        2. 发送列地址`j`（CAS请求），从行缓冲区中读取指定列的数据。
- **设计权衡**：
    - 使用二维组织可以减少地址引脚数量（例如，使用2个地址引脚而非4个）。
    - 缺点是需要两步发送地址，增加了访问时间。

---

### **4. 内存模块 (Memory Modules)**

- **模块组成**：DRAM芯片被封装为内存模块（如DIMM），用于插入主板。
    - 每个模块可以通过多个DRAM芯片并行读取/写入数据。
    - Core i7系统使用240针双列直插内存模块（DIMM），每次传输64位数据。
- **工作原理**：
    1. 内存控制器将主存地址`A`转换为超级单元地址`(i, j)`。
    2. 模块将地址广播给所有DRAM芯片。
    3. 每个芯片输出其超级单元`(i, j)`的数据，汇总形成64位数据返回。
- **多模块配置**：多个内存模块连接到内存控制器，支持扩展主存容量。
    

---

### **重难点整理**

1. **SRAM和DRAM的差异**：
    - 了解它们的存储原理及优缺点。
    - 理解为何SRAM更快但更贵，适合做缓存，而DRAM更慢但便宜，适合做主存。
2. **DRAM的二维组织与访问流程**：
    - 理解超级单元、行/列地址的概念。
    - 熟悉RAS和CAS请求的含义及工作机制。
3. **刷新与纠错**：
    - DRAM的刷新过程如何维持数据有效性。
    - 纠错码如何提高系统可靠性。
4. **内存模块的组成与数据传输**：
    - 内存控制器如何与内存模块协作完成数据读写。
    - 单个模块与多模块如何扩展系统主存容量。
### Practice Problem 6.1

确定每种 DRAM 的二维阵列的行数 r 和列数 c，使得行地址位数 br 和列地址位数 bc 中的最大值 max⁡(br,bc) 最小化。

相关知识点回顾
1. **行地址位数 br**：根据 r 的大小确定，计算公式为 br=⌈log⁡2(r)⌉。
2. **列地址位数 bcbc**：根据 cc 的大小确定，计算公式为 bc=⌈log⁡2(c)⌉。
3. **目标**：调整 r 和 c 的大小，使得 max⁡(br,bc) 最小。

---

#### 总结表格

| 阵列组织形式  | r     | c   | br  | bc  | max⁡(br,bc) |
| ------- | ----- | --- | --- | --- | ----------- |
| 16×1    | 16    | 1   | 4   | 0   | 4           |
| 16×4    | 16    | 4   | 4   | 2   | 4           |
| 128×8   | 128   | 8   | 7   | 3   | 7           |
| 512×4   | 512   | 4   | 9   | 2   | 9           |
| 1,024×4 | 1,024 | 4   | 10  | 2   | 10          |

---

#### 解答分析

通过计算可以看出，**不同组织形式的 DRAM** 会影响地址位数，进而影响系统设计中的资源占用。
- 对于小型 DRAM（如 16×1 和 16×4），行列地址位数更容易平衡。
- 随着 DRAM 阵列规模的增大，行地址位数 br 成为主导因素，影响最大位数 max⁡(br,bc)。

这道练习帮助理解了二维组织形式对 DRAM 地址设计的影响，同时也体现了如何通过阵列设计优化硬件资源分配。

### **5. Enhanced DRAMs （增强型 DRAMs）**

随着处理器速度的提高，出现了多种增强型 DRAM：
- **快速页面模式 (FPM DRAM)**: 利用行缓冲区，在同一行内进行连续访问时减少 RAS 请求。
- **扩展数据输出 (EDO DRAM)**: 允许 CAS 信号间间隔更短，进一步提升速度。
- **同步 DRAM (SDRAM)**: 使用时钟信号与控制器同步，提高了访问效率。
- **双倍数据速率 SDRAM (DDR SDRAM)**: 在时钟信号的上升和下降沿传输数据。DDR 分为 DDR、DDR2、DDR3 等版本，每代提升了预取缓冲区的大小以增加带宽。
这些优化解决了传统 DRAM 的速度瓶颈问题，尤其是 FPM 和 SDRAM 对连续访问的性能提升显著。DDR SDRAM 则通过更高效的并行性适应了现代处理器的高速需求。

---

### **6. Nonvolatile Memory（非易失性存储器）**
- **定义**：断电后仍可保留数据的存储器。
- **常见类型**：
    1. **只读存储器（ROM）**：通常不能写入，但某些类型支持有限次数的写入。
    2. **可编程 ROM（PROM）**：只能写入一次，使用高电流熔断。
    3. **可擦写 PROM（EPROM）**：通过紫外光擦除后可重新编程，可重写大约 1000 次。
    4. **电可擦写 PROM（EEPROM）**：可直接在电路板上编程，支持多达 10 万次重写。
    5. **闪存（Flash Memory）**：
        - **特点**：基于 EEPROM，速度快，耐用，常用于 SSD、手机和数码设备。
        - **用途**：固态硬盘（SSD）提供更快、更可靠且更节能的存储解决方案。
- **固件（Firmware）**：
    - 存储在 ROM 中的程序。
    - 设备启动时运行，如 PC 的 BIOS，或复杂设备的驱动程序（如显卡、磁盘控制器）。

---

### **7. Accessing Main Memory（访问主存）**
#### **总线（Bus）**
- **定义**：一组并行的导线，用于传输地址、数据和控制信号。
- **工作流程**：
    1. 地址和数据信号可以共享导线，也可以分开。
    2. 控制信号用于同步事务并区分操作类型（读、写、地址或数据）。
#### **组件连接**
- **示例系统（图 6.6）**：
    - CPU 芯片通过系统总线（System Bus）连接到 I/O 桥。
    - I/O 桥通过内存总线（Memory Bus）连接到 DRAM 主存。
#### **读操作（movq A, %rax）**
1. CPU 在系统总线上放置地址 A。
2. I/O 桥将地址信号转到内存总线，主存读取地址，提取数据并返回。
3. 数据通过 I/O 桥传回系统总线，最终被 CPU 接收。
#### **写操作（movq %rax, A）**
1. CPU 在系统总线上放置地址 A。
2. 主存读取地址后等待数据。
3. CPU 在系统总线上发送数据，主存接收并写入 DRAM。

### 总结

- **增强型 DRAM**：通过改进传统 DRAM 提高访问速度（如 FPM、EDO、SDRAM）。
- **非易失性存储器**：断电后保存数据，包括 ROM、EPROM、EEPROM 和闪存。
- **总线架构**：通过总线实现 CPU 与内存间的数据传输，操作包括读取和写入。

##  6.1.2 Disk Storage（磁盘存储）
